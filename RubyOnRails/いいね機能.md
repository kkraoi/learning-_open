# いいね機能を実装

## 非同期化
非同期通信: 送信者のデータ送信タイミングと受信者のデータ受信タイミングを合わせずに通信を行う通信方式。<br>
つまり、ページがリロードすることなく変更を反映する。

### 要件
- [ ] サーバーからのレスポンスで「いいね」ボタンのテンプレートを返すこと

### 部分テンプレートファイル作成
※book変数の部分などはよしなに調整すること

/app/views/favorites/_btn.html.erb
```
<% if book.favorited_by?(current_user) %>
  <%= link_to book_favorites_path(book), method: :delete, remote: true do %>
    <i class="fas fa-heart" aria-hidden="true" style="color: red;"></i>
    <%= book.favorites.count %> いいね
  <% end %>
<% else %>
  <%= link_to book_favorites_path(book), method: :post, remote: true do %>
    <i class="fas fa-heart" aria-hidden="true"></i>
    <%= book.favorites.count %> いいね
  <% end %>
<% end %>
```
- `remote: true`: 非同期通信(AJAX)を行うオプション引数。

### ボタンの呼び出しのラッパーにidをつける
いいねボタンテンプレートの呼び出しがあるビューファイル
```
<td id="favorite_btn_<%= モデルインスタンス.id %>">
  <%= render "favorites/btn", book: モデルインスタンス %>
</td>
```

### コントローラ調整
/app/controllers/favorites_controller.rb
```
redirect_to request.referer
```
などの記述を削除。非同期通信を行う場合は、JavaScriptファイル（.js.erb）を使用してビューを更新する。<br>
アクション内にrenderやredirect_toの記述がない場合、Railsは自動的に対応するJavaScriptファイルを探しに行く。

### js.erbファイル作成
/app/views/favorites/create.js.erb
```
$("#favorite_btn_<%= @投稿物のインスタンス変数.id %>").html("<%= j(render 'favorites/btn', book: @投稿物のインスタンス変数) %>");
```

/app/views/favorites/destroy.js.erb
```
$("#favorite_btn_<%= @投稿物のインスタンス変数.id %>").html("<%= j(render 'favorites/btn', book: @投稿物のインスタンス変数) %>");
```

上記のように、JSテンプレートを作り、もし、/app/controllers/favorites_controller.rbに投稿物のインスタンス変数が設定されていなければ
```
 # 投稿された本を定義
 @post_book = Book.find(params[:book_id])
```
などのように調整する。

【JSテンプレートとは】<br>
- フォームを送信したあとに動く命令（JS）として動く。
- コントローラーアクションから自動的に呼ばれる（renderメソッドが存在しなければ）。
- この場合↑アクション名とJSテンプレートファイル名は同じにする必要がある。
- 自動的に呼ばれるようにするためには、フォーム送信時にremote: true`が必要。

【使用するjqueryメソッド】
- `$(セレクタ).html(値)`: 対象の子要素のhtml(要素)を、カッコ内のものに変更する。
- `$(セレクタ).val(値)`: 対象のvalue属性を、カッコ内のものに変更する。
※上記のメソッドの引数が空だったら、セレクタの値を参照する挙動となる。

【j()について】<br>
- `j()` = `escape_javascript()`である。j()はescape_javascript()のエイリアス（別名）である。
- HTMLに埋め込むJavaScript文字列を安全にエスケープするためのヘルパー関数。
- XSS攻撃の対策。危ない記号（例えば ", ', \n みたいなもの）を安全な表現に変換（エスケープ）する。
- 引数: Rubyで評価して得られたデータ（文字列）を入れる。