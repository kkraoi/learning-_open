# コメント機能を実装

# 非同期化
※下記の「book_comment」や「book」は適宜、投稿物のモデル名に置き換えて読むこと

## ビューファイル調整
1. コメント数
2. コメント一覧
3. コメント投稿フォーム
のテンプレートを調整する。なければ作る。`link_to`や`form_with`に注目。

### コメント数
/app/views/book_comments/_conter.html.erb
```
コメント数： <%= book.book_comments.count %>
```

### コメント一覧
/app/views/book_comments/_index.html.erb
```
<%= link_to "Destroy", book_book_comment_path(book, book_comment), method: :delete, class: "btn btn-danger pull-right", remote: true %>
```
に変更。`remote: true`オプションで非同期通信を行えるようにする。

### コメント投稿フォーム
/app/views/book_comments/_form.html.erb
```
<%# 配列でインスタンス変数を2つ指定している。コメントは、bookに結びついたbook_commentであるため、book_commentをcreateするためのリクエストは、ルーティングもネスト（親子関係）しているため、2つの情報が必要になる。 %>
<%= form_with model: [@book, @book_comment], local: false do |f| %>
  <%= f.text_area :comment, rows: '5', placeholder: "コメントをここに", class: "w-100", id: "comment_textarea" %>
  <%= f.submit "送信する" %>
<% end %>
```
- `local: false`: form_withのオプションメソッドで、非同期通信を行えるように設定する。
- text_areaに`id: "comment_textarea"`を追加する。

### テンプレート呼び出しのラッパーにidをつける
非同期通信後に更新するテンプレート呼び出しラッパー要素を対象とする。

例えばshowページで、
```
<%# コメント数 %>
<td id="comment_counter">
  <p>コメント件数：<%= @book.book_comments.count %></p>
</td>

<%# コメント欄 %>
<div id="comment_index">
  <%= render "book_comments/index", book: @book %>
</div>
```

## コントローラー編集
/app/controllers/book_comments_controller.rb
```
redirect_to request.referer
```
などの記述を削除。非同期通信を行う場合は、JavaScriptファイル（.js.erb）を使用してビューを更新する。<br>
アクション内にrenderやredirect_toの記述がない場合、Railsは自動的に対応するJavaScriptファイルを探しに行く。

## ビュー js.erbファイル作成
/app/views/book_comments/create.js.erb
```
$("#comment_counter").html("<%= j(render "book_comments/counter", book: @comment.book) %>")
$("#comment_index").html("<%= j(render "book_comments/index", book: @comment.book) %>")
$("#comment_textarea").val("")
```

/app/views/book_comments/destroy.js.erb
```
$("#comment_counter").html("<%= j(render "book_comments/counter", book: @comment.book) %>");
$("#comment_index").html("<%= j(render "book_comments/index", book: @comment.book) %>");
```

上記のインスタンス変数（@comment）が参照できるように/app/controllers/book_comments_controller.rbを調整する。